name: Deploy Firebase Cloud Functions

on:
  # Trigger on push to main branch when functions directory changes
  push:
    branches:
      - main
    paths:
      - 'functions/**'
  
  # Allow manual workflow dispatch from GitHub UI
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Cloud Functions to Firebase
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required to checkout repository code
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'functions/package-lock.json'
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Install dependencies
        working-directory: ./functions
        run: npm ci
      
      - name: Build functions
        working-directory: ./functions
        run: npm run build
      
      - name: Configure Stripe secret key
        run: |
          echo "Setting Stripe configuration..."
          # Firebase CLI doesn't log secret values in output
          firebase functions:config:set stripe.secret_key="${STRIPE_SECRET_KEY}" --token "$FIREBASE_TOKEN"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      
      - name: Deploy to Firebase
        run: firebase deploy --only functions --token "$FIREBASE_TOKEN"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: Deployment summary
        if: success()
        run: |
          echo "âœ… Cloud Functions deployed successfully!"
          echo "Functions deployed:"
          echo "  - cartReprice"
          echo "  - createPaymentIntent"
          echo "  - handleStripeWebhook"
