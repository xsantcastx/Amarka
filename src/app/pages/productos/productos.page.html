<!-- Productos Overview Page -->
<section class="section-stack bg-ts-bg min-h-screen products-page">
  <!-- Page Header Component -->
  <app-page-header
    title="{{ heroTitleKey | translate }}"
    subtitle="{{ heroSubtitleKey | translate }}"
    [breadcrumbs]="breadcrumbs"
    icon="products">
  </app-page-header>

  @if (isValentineSeason) {
    <div class="page-container pb-6">
      <div class="valentine-banner">
        <div>
          <p class="valentine-banner__eyebrow">{{ 'products.valentine_banner.badge' | translate }}</p>
          <h3 class="valentine-banner__title">{{ 'products.valentine_banner.title' | translate }}</h3>
          <p class="valentine-banner__copy">{{ 'products.valentine_banner.subtitle' | translate }}</p>
        </div>
      </div>
    </div>
  }

  <!-- Filters Section -->
  <div class="page-container pb-12">
    <!-- Filter Toggle Bar -->
    <div class="flex items-center justify-between gap-4 mb-4">
      <button
        (click)="toggleFilters()"
        class="inline-flex items-center gap-2 px-4 py-2.5 bg-ts-paper border border-ts-line rounded-lg text-ts-ink font-medium transition-all shadow-sm hover:shadow-md hover:border-ts-accent/60">
        <svg class="w-5 h-5 text-ts-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
        </svg>
        <span>{{ showFilters ? 'Hide Filters' : 'Show Filters' }}</span>
        <svg 
          class="w-4 h-4 transition-transform"
          [class.rotate-180]="showFilters"
          fill="none" 
          stroke="currentColor" 
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>

      <!-- Active Filters Badge -->
      @if (hasFilters) {
        <div class="flex items-center gap-2">
          <span class="px-3 py-1 bg-ts-accent/10 border border-ts-accent/30 text-ts-ink text-sm font-medium rounded-full">
            {{ filteredProductsCount }} / {{ totalProductsCount }} products
          </span>
          <button 
            (click)="clearFilters()"
            class="px-3 py-1 bg-ts-paper hover:bg-ts-bg-soft border border-ts-line text-ts-ink text-sm font-medium rounded-full transition-colors">
            Clear All
          </button>
        </div>
      }
    </div>

    <!-- Collapsible Filter Panel -->
    <div 
      class="bg-ts-paper border border-ts-line rounded-2xl shadow-sm overflow-hidden transition-all duration-300"
      [class.max-h-0]="!showFilters"
      [class.max-h-[1000px]]="showFilters"
      [class.opacity-0]="!showFilters"
      [class.opacity-100]="showFilters"
      [class.mb-8]="showFilters">
      <div class="p-6">
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
          <!-- Category Filter -->
          <div>
          <label for="categoryFilter" class="block text-sm font-medium text-ts-ink mb-2">
            {{ 'products.filters.category' | translate }}
          </label>
          <select id="categoryFilter"
                  [(ngModel)]="selectedCategoryId"
                  (change)="onCategoryChange()"
                  class="w-full px-4 py-2.5 bg-ts-bg-soft border border-ts-line text-ts-ink rounded-lg focus:ring-2 focus:ring-ts-accent focus:border-ts-accent transition-all">
            <option value="">{{ 'products.filters.all_categories' | translate }}</option>
            @for (category of categories; track category.id) {
              <option [value]="category.id">{{ category.name }}</option>
            }
          </select>
        </div>

        <!-- Model Filter -->
        <div>
          <label for="modelFilter" class="block text-sm font-medium text-ts-ink mb-2">
            {{ 'products.filters.model' | translate }}
          </label>
          <select id="modelFilter"
                  [(ngModel)]="selectedModelId"
                  (change)="onModelChange()"
                  class="w-full px-4 py-2.5 bg-ts-bg-soft border border-ts-line text-ts-ink rounded-lg focus:ring-2 focus:ring-ts-accent focus:border-ts-accent transition-all">
            <option value="">{{ 'products.filters.all_models' | translate }}</option>
            @for (model of models; track model.id) {
              <option [value]="model.id">{{ model.name }}</option>
            }
          </select>
        </div>

        <!-- Search Filter -->
        <div>
          <label for="searchFilter" class="block text-sm font-medium text-ts-ink mb-2">
            {{ 'products.filters.search' | translate }}
          </label>
          <input type="text"
                 id="searchFilter"
                 [(ngModel)]="searchTerm"
                 (input)="onSearchChange()"
                 [placeholder]="'products.filters.search_placeholder' | translate"
                 class="w-full px-4 py-2.5 bg-ts-bg-soft border border-ts-line text-ts-ink placeholder-ts-ink-soft rounded-lg focus:ring-2 focus:ring-ts-accent focus:border-ts-accent transition-all"/>
        </div>
      </div>

      <!-- Tags Filter -->
      @if (allTags.length > 0) {
        <div class="px-6 pb-4">
          <label class="block text-sm font-medium text-ts-ink mb-3">
            <span class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
              </svg>
              {{ 'products.filters.filter_by_tags' | translate }}
            </span>
          </label>
          <div class="flex flex-wrap gap-2">
            @for (tagSlug of allTags; track tagSlug) {
              <button
                type="button"
                (click)="toggleTag(tagSlug)"
                [style.background-color]="isTagSelected(tagSlug) ? getTagColor(tagSlug) : 'transparent'"
                [style.color]="isTagSelected(tagSlug) ? '#FFFFFF' : getTagColor(tagSlug)"
                [style.border-color]="getTagColor(tagSlug)"
                class="px-3 py-1.5 border rounded-full text-sm font-medium transition-all hover:scale-105">
                {{ getTagName(tagSlug) }}
              </button>
            }
          </div>
        </div>
      }

      <!-- Results Count -->
      <div class="px-6 pb-6 pt-4 border-t border-ts-line">
          <p class="text-sm text-ts-ink-soft">
            @if (isLoading) {
              {{ 'products.results.loading' | translate }}
            } @else {
              {{ 'products.results.showing' | translate : { current: filteredProductsCount, total: totalProductsCount } }}
            }
          </p>
        </div>
      </div>
    </div>
  </div>  <!-- Loading State -->
  @if (isLoading) {
    <div class="page-container pb-20 text-center">
      <div class="inline-flex items-center gap-3 px-6 py-4 bg-ts-paper border border-ts-line rounded-full shadow-sm">
        <div class="app-spinner" style="--spinner-size: 72px;"><img src="/Logo Clear.png" alt="Loading" width="96" height="96"></div>
        <span class="text-ts-ink-soft font-medium">{{ 'products.results.loading' | translate }}</span>
      </div>
    </div>
  }

  <!-- Empty State -->
  @if (!isLoading && filteredProducts.length === 0) {
    <div class="page-container pb-20 text-center">
      <div class="bg-ts-paper border border-ts-line rounded-2xl shadow-sm p-12">
        <svg class="w-16 h-16 text-ts-ink-soft mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
        </svg>
        <h3 class="font-serif text-2xl text-ts-ink mb-2">{{ 'products.empty.title' | translate }}</h3>
        <p class="text-ts-ink-soft mb-6">{{ 'products.empty.message' | translate }}</p>
        @if (hasFilters) {
          <button (click)="clearFilters()"
                  class="px-6 py-3 bg-ts-accent/20 hover:bg-ts-accent/30 border border-ts-accent/30 text-ts-ink rounded-full font-semibold transition-colors">
            {{ 'products.empty.clear_button' | translate }}
          </button>
        }
      </div>
    </div>
  }

  <!-- Products by Thickness -->
  @if (!isLoading && filteredProducts.length > 0) {
    <div class="page-container pb-20">
      
      <!-- All Filtered Products -->
      <section class="mb-20">
        <div class="mb-8">
          <h2 class="font-serif text-4xl text-ts-ink mb-2">{{ sectionTitleKey | translate }}</h2>
          <p class="text-lg text-ts-ink-soft">{{ sectionSubtitleKey | translate }}</p>
        </div>
        
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-8">
          @for (producto of filteredProducts; track producto.slug) {
            <article
              class="group relative flex h-full cursor-pointer flex-col overflow-hidden rounded-2xl border border-ts-line bg-ts-paper shadow-sm transition-all duration-300 hover:-translate-y-1 hover:border-ts-accent/50 hover:shadow-md focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ts-accent"
              tabindex="0"
              role="link"
              [attr.aria-label]="producto.name"
              (click)="goToProduct(producto)"
              (keydown.enter)="goToProduct(producto, $event)"
              (keydown.space)="goToProduct(producto, $event)">
              <div class="aspect-[4/3] overflow-hidden bg-ts-bg-soft">
                @if (producto.imageUrl) {
                  <img
                    [src]="producto.imageUrl"
                    [alt]="producto.name"
                    class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                    loading="lazy"/>
                } @else {
                  <div class="flex h-full w-full items-center justify-center text-white/40">
                    <svg class="h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                }
              </div>
              <div class="flex flex-1 flex-col p-6">
                <h3 class="mb-3 font-serif text-2xl tracking-tight text-ts-ink">{{producto.name}}</h3>

                <!-- Category and Model Badges -->
                <div class="mb-4 flex flex-wrap gap-2">
                  @if (getCategoryName(producto.categoryId)) {
                    <span class="rounded border border-ts-accent/30 bg-ts-accent/10 px-2 py-1 text-xs font-medium uppercase tracking-wide text-ts-ink">
                      {{getCategoryName(producto.categoryId)}}
                    </span>
                  }
                  @if (getModelName(producto.modelId)) {
                    <span class="rounded border border-ts-accent/30 bg-ts-accent/10 px-2 py-1 text-xs font-medium uppercase tracking-wide text-ts-ink">
                      {{getModelName(producto.modelId)}}
                    </span>
                  }
                </div>

                <!-- Stock Badge -->
                

                @let priceInfo = getDisplayPrice(producto);
                @if (priceInfo) {
                  <p class="mb-6 text-lg font-semibold text-ts-ink">
                    @if (priceInfo.isFrom) {
                      <span class="text-xs uppercase tracking-wide text-ts-ink-soft mr-1">{{ 'product.from' | translate }}</span>
                    }
                    {{priceInfo.price | currency:'USD':'symbol':'1.2-2'}}
                  </p>
                }

                <div class="mt-auto flex items-center justify-between gap-3 pt-2">
                  <div class="inline-flex items-center gap-2 text-sm font-semibold text-ts-accent transition-colors group-hover:text-ts-ink">
                    <span>View product</span>
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </div>
                  <button
                    (click)="addToCart(producto, $event)"
                    [disabled]="addingProductId === (producto.id || producto.slug)"
                    class="inline-flex items-center justify-center rounded-lg border border-ts-accent/50 bg-ts-accent px-4 py-2 text-sm font-semibold text-ts-ink transition-colors hover:bg-ts-accent/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ts-accent disabled:opacity-70 disabled:cursor-not-allowed">
                    @if (addingProductId === (producto.id || producto.slug)) {
                      <span class="flex items-center gap-2">
                        <span class="h-4 w-4 rounded-full border-2 border-ts-ink border-t-transparent animate-spin"></span>
                        <span>{{ 'common.loading' | translate }}</span>
                      </span>
                    } @else if (isRecentlyAdded(producto)) {
                      <span class="flex items-center gap-2 text-green-900">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>{{ 'product.added' | translate }}</span>
                      </span>
                    } @else {
                      <span class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <span>{{ hasVariants(producto) ? ('product.select_variant' | translate) : ('product.add_to_cart' | translate) }}</span>
                      </span>
                    }
                  </button>
                </div>
              </div>
            </article>
          }
        </div>
      </section>

      <!-- Call to Action -->
      <section class="text-center py-16">
        <div class="max-w-3xl mx-auto">
          <h2 class="font-serif text-3xl text-ts-ink mb-4">{{ ctaTitleKey | translate }}</h2>
          <p class="text-lg text-ts-ink-soft mb-8">{{ ctaSubtitleKey | translate }}</p>
          <div class="flex justify-center">
            <a routerLink="/contacto" 
               class="inline-flex items-center gap-2 px-8 py-4 bg-ts-accent/20 hover:bg-ts-accent/30 border border-ts-accent/30 text-ts-ink rounded-full font-semibold transition-colors shadow-sm">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.955 8.955 0 01-3.793-.793L3 21l1.793-6.207A8.955 8.955 0 013 12a8 8 0 018-8c4.418 0 8 3.582 8 8z"/>
              </svg>
              {{ ctaButtonKey | translate }}
            </a>
          </div>
        </div>
      </section>
    </div>
  }
</section>
